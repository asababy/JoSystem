<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JoSystem - 质量管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Header 顶部导航 --- */
        header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e2e8f0;
            padding: 0 1.5rem;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-login {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            transition: background 0.3s;
        }

        .btn-login:hover { background: var(--primary-light); }

        /* --- Main 内容区 --- */
        main {
            flex: 1;
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .section-header {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* 业务模块网格 */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .module-card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            border-color: var(--primary);
        }

        .module-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .module-info h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .module-info p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .module-tag {
            align-self: flex-start;
            background: #f1f5f9;
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        /* --- Footer 底部状态栏 --- */
        footer {
            background: #fff;
            padding: 0.75rem 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: #f8fafc;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
        }

        .status-ready .dot { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-disconnected .dot { background: var(--danger); }

        #lastUpdated { font-size: 0.8rem; color: var(--text-muted); }

        /* 响应式微调 */
        @media (max-width: 640px) {
            .modules-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <i class="fas fa-shield-halved"></i>
            <span>JoSystem <small style="font-weight: 400; font-size: 0.7rem; opacity: 0.7;">V2.0</small></span>
        </div>
        
        <div class="user-profile">
            <div id="userInfo" style="display: none; align-items: center; gap: 10px;">
                <span id="userName" style="font-weight: 500;"></span>
                <button id="logoutLink" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size: 0.85rem;">[退出]</button>
            </div>
            <a href="javascript:void(0)" id="loginLink" class="btn-login" style="display: none;">
                <i class="far fa-user-circle"></i> 登录系统
            </a>
        </div>
    </header>

    <main>
        <div class="section-header">
            <h2>业务功能模块</h2>
        </div>

        <div id="modulesGrid" class="modules-grid">
            <div style="color: var(--text-muted);">正在加载业务模块...</div>
        </div>
    </main>

    <footer>
        <div id="status" class="status-pill status-disconnected">
            <span class="dot"></span>
            <span class="status-text">正在初始化...</span>
        </div>
        <div id="lastUpdated">最后更新: -</div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const state = { socket: null, isLoggedIn: false, isOnline: false };
            const api = {
                getAuth: () => fetch('/api/auth').then(r => r.json()),
                logout: () => fetch('/api/logout', { method: 'POST' }),
                getModules: () => fetch('/api/modules/nav').then(r => r.json())
            };

            const el = {
                userInfo: document.getElementById('userInfo'),
                userName: document.getElementById('userName'),
                status: document.getElementById('status'),
                statusText: document.querySelector('.status-text'),
                lastUpdated: document.getElementById('lastUpdated'),
                loginLink: document.getElementById('loginLink'),
                modulesGrid: document.getElementById('modulesGrid')
            };

            function setStatus(online, text = "") {
                state.isOnline = online;
                el.status.className = `status-pill ${online ? 'status-ready' : 'status-disconnected'}`;
                el.statusText.textContent = text || (online ? "服务器已就绪" : "连接已断开");
            }

            function initWS() {
                if (state.socket && state.socket.readyState !== WebSocket.CLOSED) return;
                const wsUri = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`;
                state.socket = new WebSocket(wsUri);
                
                state.socket.onopen = () => setStatus(true);
                state.socket.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === "serverStatus") setStatus(msg.data.running);
                        else if (msg.type === "heartbeat") {
                            el.lastUpdated.textContent = `最后同步: ${msg.time}`;
                            setStatus(true);
                        }
                    } catch (e) {}
                };
                state.socket.onclose = () => { setStatus(false); setTimeout(initWS, 3000); };
            }

            async function syncLoginStatus() {
                try {
                    const data = await api.getAuth();
                    state.isLoggedIn = !!data.authenticated;
                    el.userInfo.style.display = state.isLoggedIn ? 'flex' : 'none';
                    el.loginLink.style.display = state.isLoggedIn ? 'none' : 'flex';
                    if (state.isLoggedIn) el.userName.textContent = data.username || "管理员";
                } catch (e) {}
            }

            async function loadModules() {
                try {
                    const res = await api.getModules();
                    if (!res?.success) return;
                    el.modulesGrid.innerHTML = "";
                    res.items.forEach(m => {
                        const card = document.createElement('div');
                        card.className = 'module-card';
                        card.onclick = () => m.url && (window.location.href = m.url);
                        card.innerHTML = `
                            <div class="module-icon">${m.icon || '<i class="fas fa-box"></i>'}</div>
                            <div class="module-info">
                                <h3>${m.name}</h3>
                                <p>${m.description || '点击进入该管理模块'}</p>
                            </div>
                            ${m.category ? `<span class="module-tag">${m.category}</span>` : ''}
                        `;
                        el.modulesGrid.appendChild(card);
                    });
                } catch (e) {
                    el.modulesGrid.innerHTML = `<div style="color:var(--danger)">无法加载模块列表</div>`;
                }
            }

            document.getElementById('logoutLink').onclick = async () => { await api.logout(); location.reload(); };
            el.loginLink.onclick = () => { window.location.href = "/login.html"; };

            initWS();
            await syncLoginStatus();
            await loadModules();
        });
    </script>
</body>
</html>